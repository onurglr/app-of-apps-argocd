apiVersion: v1
kind: ConfigMap
metadata:
  name: gitea-config
  namespace: gitea
data:
  app.ini: |
    APP_NAME = Gitea: Git with a cup of tea
    RUN_MODE = prod

    [database]
    DB_TYPE = postgres
    HOST = postgresql.postgresql.svc.cluster.local:5432
    NAME = gitea
    USER = gitea
    PASSWD = gitea

    [server]
    DOMAIN = gitea.localtest.me
    SSH_DOMAIN = gitea.localtest.me
    HTTP_PORT = 3000
    ROOT_URL = http://gitea.localtest.me:30080/
    DISABLE_SSH = false
    SSH_PORT = 22

    [repository]
    ROOT = /data/git/repositories

    [session]
    PROVIDER = file

    [log]
    MODE = console
    LEVEL = Info

    # INSTALL_LOCK is set automatically by Gitea after first installation
    # Removing it allows Gitea to run migrations on fresh database
  
  # Environment variables
  USER_UID: "1000"
  USER_GID: "1000"
  
  # Init container scripts
  wait-for-postgres.sh: |
    #!/bin/sh
    until nc -z postgresql.postgresql.svc.cluster.local 5432; do
      echo "Waiting for PostgreSQL..."
      sleep 2
    done
    echo "PostgreSQL is ready!"
  
  setup-gitea-config.sh: |
    #!/bin/sh
    # Create Gitea config directory in PVC
    mkdir -p /data/gitea/conf
    # Only copy app.ini from ConfigMap to PVC if it doesn't exist
    # This preserves INSTALL_LOCK and other settings after first installation
    if [ ! -f /data/gitea/conf/app.ini ]; then
      cp /etc/gitea/app.ini /data/gitea/conf/app.ini
      echo "Copied app.ini from ConfigMap to PVC (first time setup)"
    else
      echo "app.ini already exists in PVC - preserving existing configuration (INSTALL_LOCK will be preserved)"
      # Don't overwrite - Gitea has already configured itself
      # INSTALL_LOCK = true means setup is complete, keep it!
    fi

