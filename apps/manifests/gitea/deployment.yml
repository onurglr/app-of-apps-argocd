apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitea
  namespace: gitea
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gitea
  template:
    metadata:
      labels:
        app: gitea
    spec:
      initContainers:
      - name: wait-for-postgres
        image: postgres:alpine
        command: ["/bin/sh", "/scripts/wait-for-postgres.sh"]
        volumeMounts:
        - name: init-scripts
          mountPath: /scripts
      - name: wait-for-redis
        image: redis:alpine
        command: ["/bin/sh", "/scripts/wait-for-redis.sh"]
        volumeMounts:
        - name: init-scripts
          mountPath: /scripts
      containers:
      - name: gitea
        image: gitea/gitea:latest
        ports:
        - containerPort: 3000
        env:
        # PostgreSQL Database Configuration
        - name: GITEA__database__DB_TYPE
          value: "postgres"
        - name: GITEA__database__HOST
          value: postgres.postgres.svc.cluster.local:5432
        - name: GITEA__database__NAME
          value: "gitea"
        - name: GITEA__database__USER
          value: "postgres"
        - name: GITEA__database__PASSWD
          value: "postgres"
        # Redis Cache Configuration
        - name: GITEA__cache__ENABLED
          value: "true"
        - name: GITEA__cache__ADAPTER
          value: "redis"
        - name: GITEA__cache__HOST
          value: redis.redis.svc.cluster.local:6379
        # Gitea Server Configuration
        - name: GITEA__server__PROTOCOL
          value: "http"
        - name: GITEA__server__DOMAIN
          value: "localhost"
        - name: GITEA__server__HTTP_PORT
          value: "3000"
        - name: GITEA__server__ROOT_URL
          value: "http://localhost:3000"
        # Gitea App Configuration
        - name: GITEA__app__INSTALL_LOCK
          value: "true"
      volumes:
      - name: init-scripts
        configMap:
          name: gitea-init
          defaultMode: 0755

